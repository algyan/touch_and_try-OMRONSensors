# OMRON-Handson-User　ハンズオン (3)

この文書はOMRON環境センサ(USB型)　形2JCIE-BU01のハンズオン受講者が用いる資料　その３です。

## ハンズオン（3）

この章では下記の内容について学習します。

* Microsoft Azureへの接続
  * IoT Certral設定
  * Armadillo上の設定

まずはArmadilloからランダムなデータをIoT Centralに書き込み、グラフが表示できるところまでを学習します。

### 料金についての注意

IoT Centralは5デバイスまで無料ですので、本ハンズオンで利用する限りでは料金は発生しません。ただし、メッセージ数が月50,000件を超えると料金が発生しますので注意してください。本ハンズオンでは1秒間に1メッセージを送信しますので、約13時間を超えると料金が発生します。

料金は実施時期、および選択するリージョンによって変動しますので必要に応じて確認してください。2019年4月末現在、米国東部／米国西部リージョンの価格は下記の通りです。

デバイス台数あたりの価格

| 台数 | デバイスあたり月額 |
|:--|--:|
| 0 - 5 | Free |
| 6 - 1,000 |¥219.8 |
| 1,001 - 10,000 |¥164.9 |
| 10,001 - 100,000 |¥109.9 |
| 100,001 以上 |¥55.0 |

追加メッセージの価格

* メッセージ百万件ごと ¥560

### IoT Central 設定

事前にAzure Consoleにアクセスできるよう準備しておいてください。

Azureではクラウド上に作成されるリソースを「リソースグループ」という単位で管理します。ここでは、本ハンズオンで使用するリソースグループを作成します。

1. Azure Portalの左ペインから「リソースグループ」を選択し、「追加」をクリック
1. 「リソースグループを作成します」画面から下記の通りパラメータを入力し、「確認して作成」をクリック
    * サブスクリプション　（環境に合わせて選択）
    * リソースグループ　omron-sensor-handson
    * リージョン　（講師の指示に従ってください）

作成したリソースグループの内部に「IoT Central アプリケーション」を作成します。

1. Azure Portalから「リソースの作成」を選択し、検索窓に「IoT Central」と入力します。
1. 表示された「IoT Central アプリケーション」を選択し、「作成」をクリックします。
1. アプリケーション作成画面に下記の通りパラメータを入力し、「作成」ボタンを押します。
    * リソース名 omron-sensor-handson-(お好きな文字列)
    * アプリケーションURL　リソース名と同じ
    * テンプレート　カスタムアプリケーション
    * 価格レベル　有料アプリケーション
    * サブスクリプション　（環境に合わせて選択）
    * リソースグループ　omron-sensor-handson

作成されたIoT Centralアプリケーションの設定画面を表示します。

1. ブラウザを使用して、先程設定した「アプリケーションURL」を表示
    * Azure Portalにログインしたブラウザの新規タブを使用してください。
    * `https://omron-sensor-handson-***.azureiotcentral.com/`のようなURLになります。

OMRON環境センサのデータを格納するためのテンプレートを作成します。

1. IoT Central設定画面から「デバイステンプレート」を選択し、「新規」をクリックします。
1. 「新しいテンプレート」画面から「カスタム」を選択します。
1. デバイステンプレート名に「omron-sensor-sound」を入力し、「作成」をクリックします。
1. しばらく待って「omron-sensor-sound」のテンプレート画面が表示されるのを待ちます。

センサーデータを格納するための「テレメトリ」テンプレートを作成します。

1. 「新しい測定」をクリックし、「テレメトリ」をクリックします。
1. テレメトリ作成画面から下記のパラメータを入力し、「保存」をクリックします。
    * Display Name　騒音
    * フィールド名　sound
    * 単位 dB
    * 最小値　30
    * 最大値　120
    * 小数点以下桁数　2

ONRON環境センサに内蔵されている騒音センサの出力値は0.01dB刻みの整数値（符号付きInt16）で、最小値は33.00dB(0x0BB8)、最大値は120.00dB(0x2EE0)なのでこのようなパラメータになります。

ONRON環境センサに相当する「実デバイス」を作成します。

1. IoT Central設定画面から「デバイスエクスプローラー」を選択し、先程作成したテンプレート「omron-sensor-sound」を選択します。
    * 他にテンプレートを作成していなければ、自動的にomron-sensor-soundが選択されているはずです。
1. 右上に表示された「+」ボタンをクリックし、「実際」を選択します。
1. 表示された「デバイスID」「デバイス名」をメモし、「作成」をクリックします。
1. 作成されたデバイスの設定画面が表示されるので、右上の「接続」ボタンをクリックします。表示された接続用のパラメータ「スコープID」「主キー」「セカンダリキー」をメモし、「閉じる」をクリックします。

これでIoT Centralの設定は完了です。

### 接続文字列の生成

プログラムからIoT Centralにデータを送信する際には、先程メモした接続用のパラメータから生成された「接続文字列」を用いる必要があります。作成方法は下記の通りです。

1. 作業用PCからターミナルを開き、ハンズオンのディレクトリに移動
1. 先程メモした内容を使い、下記のコマンドを実行

    ```sh
    $ export DI=<デバイスID>
    $ export DK=<主キー>
    $ export SI=<スコープID>
    $ dps-keygen -di:$DI -dk:$DK -si:$SI
    HostName=iotc-......
    ```

1. 表示された文字列をメモしておく
    * `HostName=iotc-......`のような文字列です。

### データ送信

これで準備ができたので、下記のコマンドを実行し、IoT Centralにデータを送信します。

```sh
$ export CS='<接続文字列>'  # 接続文字列の前後に引用符を入れて下さい。
$ node handson3.js
```

`Device successfully connected to Azure IoT Central`と表示され、1秒おきにデータが表示されるようになれば成功です。しばらく待ってから、ブラウザに表示されているIoT Centralアプリケーション設定画面からデバイス「」のページを開くと、送信されたデータが折れ線グラフで表示されているはずです。初期状態では、12秒間の平均値が表示されています。

データが正常にグラフ表示されることを確認したらCTRL-Cを押してプログラムを終了させます。

処理内容を解説します。

[TODO]解説を書く

[ハンズオン(2)](2.md)に戻る / [ハンズオン(4)](4.md)に進む
